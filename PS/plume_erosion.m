clear all, close all, clc

set( 0, 'defaulttextinterpreter', 'latex' )
set( 0, 'defaultlegendinterpreter', 'latex' )
set( groot,'defaultaxesfontSize', 17 )

% ESTIMATE THRUSTER PLUME EROSION AND CONTAMINATION
% MR107V 300 N thruster (hydrazine)

%% Mass rate deposition
m_dry = 508.2*1.2 ; % [ kg ] - Lander dry mass
m_prop = 182.21 ; % [ kg ] - Propellant mass coming from MA 
m_lander = m_dry + m_prop ; % [ kg ] - Lander total mass (from architecture_sizing.m)
g = 0.1 ; % [ m/s^2 ] - Enceladus gravitational acceleration
T = m_lander * g ; % [ N ] - Thrust needed during landing (assumed to be equal to lander weight)

Isp = 229 ; % [ s ] - Specific impulse of MR107T thruster
g0 = 9.81 ; % [ m/s ] - Gravitational acceleration on Earth at sea level
mdot = T / ( Isp * g0 ) ; % [ kg/s ] - Mass flow raterequired to generate thrust T

alpha = deg2rad( 45 ) ; % [ rad ] - Half-cone angle representing exhaust plume expansion -> height and ardius of the cone are equal

% v = 0.75 ; % [ m / s ] - Velocity at landing (assumed from literature)

%h = 20 ;

v_profile = [-0.007988147680938865	-0.11986869004426229	-0.07409176854309067;
-0.01381855273918611	-0.1121475160858683	-0.0711667529430735;
-0.014242975042048312	-0.11168648155130675	-0.07141004374502798;
-0.01433170784173107	-0.1117530087322335	-0.0719258174727116;
-0.014421065290271614	-0.11181784498575681	-0.07244546533451762;
-0.014511053304592231	-0.11188094926448862	-0.07296902684767911;
-0.014601677852004639	-0.1119422795549247	-0.0734965419354612;
-0.014692944949857577	-0.11200179285322509	-0.07402805092772079;
-0.014784860665132618	-0.11205944514035991	-0.0745635945614282;
-0.014877431113983904	-0.11211519135660764	-0.07510321398076583;
-0.014970662461218953	-0.11216898537538479	-0.0756469507370152;
-0.015064560919718183	-0.11222077997639548	-0.07619484678814376;
-0.01515913374153601	-0.11227053799340439	-0.07674695301468516;
-0.015254387244060443	-0.11231820990431286	-0.07730331222515192;
-0.015350326789654214	-0.11236373385712033	-0.07786395908487884;
-0.015446958775751056	-0.11240705797304149	-0.07842893716957447;
-0.015544289644743416	-0.11244812913465288	-0.07899829045429017;
-0.015642325881676574	-0.11248689295397167	-0.07957206331177251;
-0.015741074013781567	-0.11252329374118349	-0.08015030050836122;
-0.01584054060946996	-0.11255727447104774	-0.08073304720128528;
-0.015940732276171276	-0.11258877674925946	-0.0813203489346108;
-0.016041655659593607	-0.11261774077827003	-0.08191225163414342;
-0.0161433174426128	-0.11264410532116789	-0.08250880160300388;
-0.016245724344014067	-0.1126678076672854	-0.0831100455135265;
-0.016348883107602123	-0.1126887835860687	-0.08371603041291832;
-0.01645280050761305	-0.11270696729538267	-0.08432680370735686;
-0.016557483354330358	-0.11272229142968454	-0.0849424131441573;
-0.01666293848624242	-0.11273468699092949	-0.08556290681524631;
-0.01676917276776998	-0.11274408330859272	-0.08618833314656402;
-0.01687619308497755	-0.11275040799705191	-0.08681874088865003;
-0.016984006329683842	-0.11275358690697178	-0.08745417911406696;
-0.017092619401903406	-0.11275354408472248	-0.0880946972002467;
-0.017202039230641435	-0.11275020173480271	-0.08874034480473746;
-0.01731227276855705	-0.1127434801701744	-0.08939117185572673;
-0.017423326978767018	-0.1127332977611293	-0.09004722854277396;
-0.017535208825682696	-0.11271957088354252	-0.09070856530507569;
-0.017647925321215074	-0.11270221388694424	-0.09137523278772768;
-0.017761483456769842	-0.1126811390224939	-0.09204728185507154;
-0.01787589008560861	-0.11265625635340153	-0.09272476362800432;
-0.017991152039060536	-0.11262747374545562	-0.09340772939709945;
-0.018107276258422653	-0.112594696851535	-0.0940962305392878;
-0.018224269700207112	-0.11255782902349915	-0.09479031854278908;
-0.0183421392443101	-0.11251677123039737	-0.09549004501919514;
-0.01846089172792815	-0.11247142201173134	-0.09619546165827925;
-0.018580533945441898	-0.11242167741930394	-0.09690662019659697;
-0.018701072631362985	-0.11236743095254895	-0.09762357239203712;
-0.01882251446671543	-0.11230857349978156	-0.09834636998571446;
-0.018944866078138996	-0.11224499327700434	-0.09907506466394313;
-0.01906813402481555	-0.11217657576040373	-0.09980970802493809;
-0.01919232479291971	-0.1121032036188474	-0.10055035154095575;
-0.019317443720421566	-0.11202474628772975	-0.10129703703199303;
-0.019443497109097974	-0.11194108065690776	-0.10204981555004959;
-0.019570492234605986	-0.11185209092872533	-0.10280874740911242;
-0.01969843519689251	-0.11175764785171716	-0.10357388314248694;
-0.01982733197520668	-0.11165761901390099	-0.10434527292775443;
-0.01995718841748396	-0.11155186876818864	-0.1051229665325601;
-0.02008801022918465	-0.11144025815641355	-0.10590701325741532;
-0.020219802961563074	-0.11132264483214192	-0.10669746187512766;
-0.020352571999342782	-0.11119888298228016	-0.1074943605670225;
-0.020486323676254366	-0.1110688333863392	-0.10829776656795935;
-0.020621063017006697	-0.11093234301523959	-0.10910772671337964;
-0.020756793701237855	-0.11078924502509527	-0.10992427728785102;
-0.02089352031239165	-0.11063937892734911	-0.11074746339604162;
-0.021031247195908775	-0.11048258035774186	-0.11157732917559134;
-0.021169978444946756	-0.1103186809913248	-0.11241391770929487;
-0.021309717886272582	-0.11014750845811498	-0.11325727093129176;
-0.021450468451661417	-0.10996888130307655	-0.11410742462399498;
-0.021592232740249413	-0.1097826138191485	-0.11496441313344816;
-0.021735015442594968	-0.10958853586045007	-0.11582828917683265;
-0.02187881970689512	-0.10938646295686393	-0.11669909411144304;
-0.022023646492089734	-0.1091761912795153	-0.11757685265335004;
-0.02216949758104524	-0.10895752234348545	-0.11846159763904594;
-0.022316374334994032	-0.10873025300140685	-0.11935335996794923;
-0.022464277670542335	-0.10849417535467508	-0.12025216846555489;
-0.02261320803525533	-0.10824907666586606	-0.1211580497392928;
-0.022763165485508594	-0.10799473926795589	-0.1220710280175187;
-0.02291414976410724	-0.10773094047032128	-0.12299112497841305;
-0.02306615932830327	-0.107457452513686	-0.12391835968721865;
-0.023219192047710627	-0.10717404245517394	-0.12485274834555737;
-0.02337324590848054	-0.10688047205414986	-0.12579430403171257;
-0.02352831803889952	-0.10657649773179104	-0.12674303661363057;
-0.023684404775657728	-0.10626187048580403	-0.12769895253760657;
-0.023841501733806066	-0.10593633581002415	-0.12866205461146574;
-0.023999603768054673	-0.10559963362085079	-0.12963234178879798;
-0.024158704933404197	-0.10525149818707141	-0.1306098089433352;
-0.024318798444726345	-0.10489165806338427	-0.13159444663371525;
-0.02447987663303746	-0.1045198360285433	-0.13258624085789472;
-0.024641930899877217	-0.10413574902728626	-0.13358517279807974;
-0.024804951670330533	-0.10373910811765293	-0.13459121855488568;
-0.02496892834704268	-0.10332961842598404	-0.13560434886857783;
-0.025133849262576415	-0.1029069791075119	-0.13662452882974382;
-0.02529970162658019	-0.10247088331354438	-0.13765171757950923;
-0.025466471471406602	-0.10202101816695786	-0.1386858679974945;
-0.02563414359736001	-0.10155706474645658	-0.13972692637754583;
-0.02580270012521349	-0.10107868891807296	-0.1407748214834379;
-0.025972123206178595	-0.10058555971698632	-0.14182948537130213;
-0.0261423949811644	-0.10007734926855096	-0.14289085310678623;
-0.026313494730364692	-0.09955371452184522	-0.14395884114917745;
-0.026485400196502615	-0.09901430646269554	-0.14503335756273172;
-0.026658087517957087	-0.09845877016851447	-0.14611430161648264;
-0.026831531159959933	-0.09788674487843334	-0.1472015633702304;
-0.027005704493748145	-0.09729786811582511	-0.14829502812054385;
-0.02718057922319365	-0.09669177258008727	-0.14939457216851781;
-0.02735612372010242	-0.09606807651561063	-0.15050005048974632;
-0.027532302778455066	-0.09542638312828326	-0.15161129511312285;
-0.02770908138863897	-0.09476630419608756	-0.152728143348851;
-0.027886423886497036	-0.0940874552680909	-0.1538504314488388;
-0.02806429094390498	-0.09338943823293289	-0.15497797233938362;
-0.028242640944624406	-0.09267185040872183	-0.15611056596839848;
-0.028421429900498372	-0.0919342848113033	-0.15724799878096626;
-0.028600611366498715	-0.09117633045219227	-0.1583900431847995;
-0.028780136354797835	-0.09039757266792921	-0.1595364570063111;
-0.028959953248055177	-0.0895975934825758	-0.1606869829386062;
-0.029140007712135835	-0.08877597200519935	-0.16184134798181718;
-0.029320242608500843	-0.0879322848642443	-0.16299926287756292;
-0.029500597906540225	-0.08706610668049838	-0.16416042153881713;
-0.02968101059613909	-0.0861770105806857	-0.16532450047616856;
-0.029861414600811088	-0.08526456875346451	-0.16649115822328553;
-0.030041740691751057	-0.08432835304968343	-0.1676600347620638;
-0.030221916403201664	-0.08336793562893957	-0.16883075095098612;
-0.030401865949556753	-0.08238288965394981	-0.17000290795791834;
-0.03058151014466566	-0.081372790034813	-0.17117608670038367;
-0.03076076632383397	-0.0803372142246494	-0.172349847295985;
-0.03093954826905969	-0.07927574306839795	-0.17352372852595446;
-0.03111776613807801	-0.07818796170611976	-0.17469724731483469;
-0.03129532639783129	-0.07707346053238329	-0.17586989823013352;
-0.031472131763018	-0.07593183621279934	-0.17704115300537446;
-0.03164808114041647	-0.07476269275881005	-0.17821046009081548;
-0.03182306957971687	-0.07356564266162705	-0.1793772442355381;
-0.03199698823163543	-0.07234030808581486	-0.18054090610618534;
-0.0321697243141249	-0.07108632212291614	-0.1817008219463516;
-0.03234116108752438	-0.06980333010512718	-0.18285634328205122;
-0.032511177839534965	-0.06849099097866097	-0.18400679667849376;
-0.032679649880932936	-0.0671489787361267	-0.18515148355333086;
-0.032846448552959324	-0.06577698390679942	-0.18628968005238047;
-0.03301144124735438	-0.06437471510318771	-0.1874206369935463;
-0.03317449143901895	-0.06294190065489161	-0.18854357998761626;
-0.033335458664406355	-0.06147829012874484	-0.1896577092939772;
-0.03350041884919765	-0.05992484439644292	-0.1906393868015593;
-0.03376637612056268	-0.05802291793321045	-0.1908106444736915;
-0.03408933436050928	-0.05599147424350792	-0.19064999512992245;
-0.03427691150590583	-0.054220797398797385	-0.19128561316383275;
-0.034425077831880646	-0.052601150820577265	-0.19234343731038905;
-0.03457017905399431	-0.05095009176859267	-0.19338746558875367;
-0.03471205248013874	-0.0492675478802304	-0.19441676703439287;
-0.034850532529895374	-0.04755347980501603	-0.1954303898826693;
-0.03498545093287749	-0.04580788300559634	-0.1964273624902521;
-0.03511663694878159	-0.04403078955818397	-0.19740669438235914;
-0.035243917609725284	-0.042222269943558426	-0.1983673774297119;
-0.035367117985334665	-0.04038243481925862	-0.19930838715933288;
-0.035486061470936546	-0.038511436762783166	-0.20022868420257775;
-0.03560057009908281	-0.036609471974994506	-0.20112721588262192;
-0.03571046487449009	-0.034676781932281284	-0.20200291794392605;
-0.035815566132317234	-0.032713654975522644	-0.2028547164243471;
-0.03591569391954198	-0.030720427823231023	-0.203681529669934;
-0.036010668399003305	-0.02869748699598206	-0.20448227049203754;
-0.03610031027548705	-0.026645270138692632	-0.20525584846429815;
-0.03618444124301987	-0.02456426722717152	-0.2060011723566734;
-0.036262884452324166	-0.022455021645068088	-0.2067171527020623;
-0.03633546499715289	-0.02031813111741584	-0.20740270448984383;
-0.03640201041799847	-0.018154248486929873	-0.20805674997947465;
-0.03646235122143059	-0.015964082319514107	-0.20867822162562966;
-0.03651632141308102	-0.01374839732573821	-0.20926606510502427;
-0.03656375904205677	-0.011508014585648789	-0.2098192424338829;
-0.03660450675433579	-0.009243811564890785	-0.21033673516330575;
-0.03663841235247156	-0.006956721911033957	-0.21081754763831248;
-0.036665329358728224	-0.004647735019990639	-0.21126071030556035;
-0.03668511757856608	-0.0023178953637043517	-0.21166528305264395;
-0.03669764366122583	3.1698428472767995E-5	-0.21203035856146743;
-0.036702781654002564	0.002399894740606828	-0.21235506565645662;
-0.03670041354667486	0.004785490397453109	-0.21263857262789806;
-0.03669042980245581	0.007187232350669529	-0.2128800905096344;
-0.03667272987176815	0.009603819624311625	-0.21307887628995428;
-0.036647222685116505	0.012033905518055983	-0.21323423603346178;
-0.036613827121339336	0.01447610006427757	-0.21334552789288225;
-0.036572472447572425	0.016928972733029148	-0.21341216498771748;
-0.036523098727347304	0.019391055376563705	-0.21343361812910558;
-0.036465657193382635	0.021860845402842086	-0.21340941836891564;
-0.036400110581799476	0.024336809165319856	-0.2133391593530438;
-0.036326433424717225	0.026817385553806364	-0.21322249945933736;
-0.03624461229843607	0.029300989769544313	-0.21305916370165504;
-0.03615464602471947	0.0317860172652233	-0.21284894538378948;
-0.03605654582301619	0.03427084782916873	-0.21259170748765222;
-0.03595033646061385	0.03675384844354717	-0.21228739571453684;
-0.035790751720056024	0.039207707889571605	-0.21150222828554868;
-0.035262568387574605	0.04118178492256753	-0.20834285095094413;
-0.03438432328258711	0.04283530837345855	-0.2036000895155237;
-0.033745187443086536	0.04491111741869787	-0.20044438963316244;
-0.033070571915215216	0.046725068886520324	-0.19650693625522572;
-0.031949633189474566	0.047637998816744194	-0.1889865267066078;
-0.030243267192747315	0.047495074352212584	-0.17773379946855594;
-0.02785734927918991	0.0460909967072859	-0.16275029577726544;
-0.025188616640422698	0.04426360886485644	-0.14680951433739717;
-0.02272021721024951	0.0422504149756869	-0.13164399846214322;
-0.020183226000438644	0.03963000971696102	-0.1162654598721668;
-0.017333373915045126	0.03541182803578744	-0.09898268553650062;
-0.01385737455192444	0.028495397200408577	-0.07727623120169161;
-0.009546179340730675	0.019428588170637556	-0.05082226217304321;
-0.0049577738594667	0.010380376398286975	-0.025809423902661093;
-2.3149662714979196E-4	4.962667798053581E-4	-8.367963236296999E-4]*1e3;

h_vect = linspace( 2, 30, size(v_profile,1) ) ; % [ m ] - Height from ground at which we turn off the thrusters

t_landing = linspace( 0, 2000, length(v_profile) ) ; 

m_fluence = zeros( length( v_profile ), 1 ) ; % Initialize vector

v_norm = zeros( 200, 1 ) ;
for k = 1 : size( v_profile, 1 )
    v_norm( k, 1 ) = norm(v_profile( k, : ) ) ;
end

v = mean( v_norm ) ;



%% Plot if we consider mean landing velocity and different cut-off altituted
for k = 1 : length( h_vect )
    h = h_vect(k);
    m_fluence(k) = T / ( Isp * g0 * pi * h * v ) ; % [ kg / m^2 ] - Derivative of mass flux within the cone over time

    r = h * tan( deg2rad( 30 ) ) ; % radius of the cone

    m_fluence_new(k) = 4 * 220 / ( Isp * g0 * pi * h * v * tan( 30 ) ^ 2 ) ; % mass fluence for each thruster

end

m_fluence = m_fluence * 1e6 ; % [ mg/ m ^ 2 ]
m_fluence_new = m_fluence_new * 1e6 ;
scale = 0.1 ; % Scaling factor (account for percentage of ammonia in thruster plume) - from literature (Phoenix lander)

% Plot the mass fluence as function of cutoff height (old method)
figure()
plot( h_vect, m_fluence, 'Linewidth', 2 )
hold, grid on
plot( h_vect, m_fluence * scale, 'Linewidth', 2 )
xlabel( 'Cutoff height [m]' ), ylabel( 'Mass fluence [$mg/m^2$]' )
title( 'Exhaust plume deposition' )
legend( 'Exhaust plume deposition', '$NH_3$ deposition', 'location', 'best' )

% Plot the mass fluence as function of cutoff height (new method)
figure()
plot( h_vect, m_fluence_new, 'Linewidth', 2 )
hold, grid on
plot( h_vect, m_fluence_new * scale, 'Linewidth', 2 )
xlabel( 'Cutoff height [m]' ), ylabel( 'Mass fluence [$mg/m^2$]' )
title( 'Exhaust plume deposition' )
legend( 'Exhaust plume deposition', '$NH_3$ deposition', 'location', 'best' )

% Plot - comparison of different methods
figure()
plot( h_vect, m_fluence * scale, 'Linewidth', 2 )
hold on, grid on
plot( h_vect, m_fluence_new * scale, '--', 'Linewidth', 2 ) % mass fluence considering all 4 thrusters
xlabel( 'Cutoff height [m]' ), ylabel( 'Mass fluence [$mg/m^2$]' )
title( 'Exhaust plume deposition' )
legend( '$NH_3$ deposition', 'prova', 'location', 'best' )

% %% Plot if we consider the actual variation of the velocity during landing phase and fixed cut-off altitude
% h = 20 ;
% for k = 1 : length( v_profile )
%     v = v_profile( k ) ;
%     h1 = 50 ;
%     h2 = 30;
%     h3 = 15;
%     h4 = 2;
%     m_fluence1(k) = T / ( Isp * g0 * pi * h1 * v ) ; % [ kg / m^2 ] - Derivative of mass flux within the cone over time
%     m_fluence2(k) = T / ( Isp * g0 * pi * h2 * v ) ; % [ kg / m^2 ] - Derivative of mass flux within the cone over time
%     m_fluence3(k) = T / ( Isp * g0 * pi * h3 * v ) ; % [ kg / m^2 ] - Derivative of mass flux within the cone over time
%     m_fluence4(k) = T / ( Isp * g0 * pi * h4 * v ) ; % [ kg / m^2 ] - Derivative of mass flux within the cone over time
% 
% end
% 
% m_fluence1 = m_fluence1 * 1e6 ; % [ mg/ m ^ 2 ]
% m_fluence2 = m_fluence2 * 1e6 ; % [ mg/ m ^ 2 ]
% m_fluence3 = m_fluence3 * 1e6 ; % [ mg/ m ^ 2 ]
% m_fluence4 = m_fluence4 * 1e6 ; % [ mg/ m ^ 2 ]
% 
% scale = 0.1 ; % Scaling factor (account for percentage of ammonia in thruster plume) - from literature (Phoenix lander)
% 
% % Plot the mass fluence as function of cutoff height (plot brutto)
% figure()
% plot( v_profile, m_fluence1 * scale, 'o', 'Color',  [0 0.4470 0.7410],  'Linewidth', 1 )
% hold, grid on
% plot( v_profile, m_fluence2 * scale, 'square', 'Color',[0.4660 0.6740 0.1880],'Linewidth', 1 )
% plot( v_profile, m_fluence3 * scale, '*', 'Color', [0.9290 0.6940 0.1250],'Linewidth', 1 )
% plot( v_profile, m_fluence4 * scale, '^', 'Color', [0.6350 0.0780 0.1840], 'Linewidth', 1 )
% xlabel( 'Descent velocity [m/s]' ), ylabel( 'Mass fluence [$mg/m^2$]' )
% title( '$NH_3$ deposition' )
% legend( '$h=50 \ m$', '$h=30 \ m$', '$h=15 \ m$', '$h=2 \ m$', 'location', 'best' )
% 
% figure()
% scatter(v_profile, m_fluence1 * scale, [], t_landing, 'Linewidth', 1.2 )
% hold on, grid on
% s = scatter(v_profile, m_fluence2 * scale, [], t_landing, 'Linewidth', 1.2 )
% s.Marker = 'square' ;
% s = scatter(v_profile, m_fluence3 * scale, [], t_landing, 'Linewidth', 1.2 )
% s.Marker = '^' ;
% s = scatter(v_profile, m_fluence4 * scale, [], t_landing, 'Linewidth', 1.2 )
% s.Marker = 'x' ;
% colorbar
% colormap jet
% xlabel( 'Descent velocity [m/s]' ), ylabel( 'Mass fluence [$mg/m^2$]' )
% title( '$NH_3$ deposition' )
% legend( '$h=50 \ m$', '$h=30 \ m$', '$h=15 \ m$', '$h=2 \ m$', 'location', 'best' )

